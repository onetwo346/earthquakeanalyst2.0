<script>
    let earthquakeData = [];
    let dangerousEarthquakes = [];
    let stats = {}; // Object to store data by date
    let currentMapData = [];
    const aiInsights = [
        {
            prediction: "Severe shaking detected. High alert.",
            riskAssessment: ["Major structural risks.", "Aftershocks likely.", "Infrastructure disruption possible."],
            safetyMeasures: ["Take cover under solid structures.", "Avoid windows and tall objects.", "Prepare for aftershocks."]
        },
        {
            prediction: "Moderate activity observed.",
            riskAssessment: ["Minor damage potential.", "Short-term aftershocks possible."],
            safetyMeasures: ["Secure loose items.", "Check building stability.", "Monitor updates."]
        },
        {
            prediction: "Low-level tremors.",
            riskAssessment: ["Minimal risk detected.", "Brief activity expected."],
            safetyMeasures: ["Stay cautious.", "Secure small objects.", "Remain indoors if possible."]
        }
    ];

    const map = L.map('earthquakeMap', {
        zoomControl: true,
        doubleClickZoom: false,
        scrollWheelZoom: true
    }).setView([0, 0], 2);
    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '© <a href="https://stadiamaps.com/">Stadia Maps</a>, © <a href="https://openmaptiles.org/">OpenMapTiles</a>, © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
        tileSize: 256
    }).addTo(map);

    function fetchData() {
        fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson") // Changed to all_week
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => {
                earthquakeData = data.features;
                processEarthquakeData();
                currentMapData = earthquakeData;
                if (document.getElementById("earthquakeMap").style.display === "block") updateMap();
                generateAIAnalysis();
                storeDataForStats();
            })
            .catch(error => {
                document.getElementById("earthquakeData").innerHTML = `Error: ${error.message}`;
                console.error("Fetch error:", error);
            });
    }

    // Auto-fetch data every 5 minutes
    fetchData(); // Initial fetch on page load
    setInterval(fetchData, 300000); // 5 minutes in milliseconds

    function processEarthquakeData() {
        const container = document.getElementById("earthquakeData");
        container.innerHTML = `<h2>Latest Earthquakes (Updated: ${new Date().toLocaleString()})</h2>`;
        if (earthquakeData.length) {
            earthquakeData.forEach(quake => {
                const { place, mag, time } = quake.properties;
                const date = new Date(time).toLocaleString();
                container.innerHTML += `
                    <div>
                        <strong>Location:</strong> ${place}<br>
                        <strong>Magnitude:</strong> ${mag.toFixed(1)}<br>
                        <strong>Time:</strong> ${date}<hr>
                    </div>`;
            });
        } else {
            container.innerHTML += "<p>No earthquakes recorded yet.</p>";
        }
    }

    function storeDataForStats() {
        earthquakeData.forEach(quake => {
            const time = new Date(quake.properties.time);
            const dateKey = time.toLocaleDateString("en-US", { timeZone: "UTC" });
            if (!stats[dateKey]) stats[dateKey] = [];
            // Avoid duplicates by checking quake ID
            const quakeExists = stats[dateKey].some(q => q.id === quake.id);
            if (!quakeExists) stats[dateKey].push(quake);
        });
    }

    function viewRegularEarthquakes() {
        if (earthquakeData.length) {
            processEarthquakeData();
            currentMapData = earthquakeData;
            if (document.getElementById("earthquakeMap").style.display === "block") updateMap();
        } else {
            document.getElementById("earthquakeData").innerHTML = "<h2>Regular Quakes</h2><p>No data yet. Tap 'Fetch Data' to load.</p>";
        }
        document.getElementById("statsView").style.display = "none";
    }

    function viewDangerousEarthquakes() {
        const container = document.getElementById("earthquakeData");
        container.innerHTML = "<h2>High-Impact Quakes (Mag ≥ 4.0)</h2>";
        if (earthquakeData.length) {
            dangerousEarthquakes = earthquakeData.filter(e => e.properties.mag >= 4.0);
            if (dangerousEarthquakes.length) {
                dangerousEarthquakes.forEach(quake => {
                    const { place, mag, time } = quake.properties;
                    const date = new Date(time).toLocaleString();
                    container.innerHTML += `
                        <div class="dangerous">
                            <strong>Location:</strong> ${place}<br>
                            <strong>Magnitude:</strong> ${mag.toFixed(1)}<br>
                            <strong>Time:</strong> ${date}<hr>
                        </div>`;
                });
                currentMapData = dangerousEarthquakes;
                if (document.getElementById("earthquakeMap").style.display === "block") updateMap();
            } else {
                container.innerHTML += "<p>No high-impact quakes found.</p>";
                currentMapData = [];
                if (document.getElementById("earthquakeMap").style.display === "block") updateMap();
            }
        } else {
            container.innerHTML += "<p>No data yet. Tap 'Fetch Data' to load.</p>";
        }
        document.getElementById("statsView").style.display = "none";
    }

    function viewStats() {
        const statsView = document.getElementById("statsView");
        if (statsView.style.display === "block") {
            statsView.style.display = "none";
        } else {
            statsView.style.display = "block";
            const datePicker = document.getElementById("statsDatePicker");
            datePicker.value = new Date().toISOString().split("T")[0];
            updateStats();
        }
    }

    function updateStats() {
        const statsContent = document.getElementById("statsContent");
        const selectedDate = new Date(document.getElementById("statsDatePicker").value)
            .toLocaleDateString("en-US", { timeZone: "UTC" });
        statsContent.innerHTML = `<h3>Stats for ${selectedDate}</h3>`;
        if (stats[selectedDate] && stats[selectedDate].length) {
            statsContent.innerHTML += `<p><strong>Total Quakes:</strong> ${stats[selectedDate].length}</p>`;
            stats[selectedDate].forEach(quake => {
                const { place, mag, time } = quake.properties;
                const date = new Date(time).toLocaleString();
                statsContent.innerHTML += `
                    <div>
                        <strong>Location:</strong> ${place}<br>
                        <strong>Magnitude:</strong> ${mag.toFixed(1)}<br>
                        <strong>Time:</strong> ${date}
                    </div>`;
            });
        } else {
            statsContent.innerHTML += "<p>No data recorded for this date yet. Data available from the past week only.</p>";
        }
    }

    function generateAIAnalysis() {
        const aiSection = document.getElementById("aiFeedback");
        aiSection.style.display = "block";
        let currentIndex = 0;
        function updateAIInsight() {
            const insight = aiInsights[currentIndex];
            aiSection.innerHTML = `
                <h2>AI Insights</h2>
                <div class="ai-prediction">${insight.prediction}</div>
                <div class="risk-assessment"><strong>Risk Assessment:</strong><br>${insight.riskAssessment.join("<br>")}</div>
                <div class="safety-measures"><strong>Safety Measures:</strong><br>${insight.safetyMeasures.join("<br>")}</div>
            `;
            currentIndex = (currentIndex + 1) % aiInsights.length;
        }
        updateAIInsight();
        clearInterval(window.aiCycleInterval);
        window.aiCycleInterval = setInterval(updateAIInsight, 5000);
    }

    function updateMap() {
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) map.removeLayer(layer);
        });

        if (!currentMapData || !currentMapData.length) {
            map.setView([0, 0], 2);
            document.getElementById("earthquakeMap").innerHTML = '<p style="text-align: center; padding: 10px;">No quakes recorded yet.</p>';
            map.invalidateSize();
            return;
        }

        const markers = currentMapData.map(quake => {
            const coords = quake.geometry.coordinates; // [lon, lat, depth]
            const { place, mag, time } = quake.properties;
            const markerSize = Math.max(10, mag * 5);
            const marker = L.marker([coords[1], coords[0]], {
                title: `${place} (Mag: ${mag.toFixed(1)})`
            }).addTo(map);
            marker.bindPopup(`<b>${place}</b><br>Magnitude: ${mag.toFixed(1)}<br>Time: ${new Date(time).toLocaleString()}`);
            marker.setIcon(L.divIcon({
                className: 'earthquake-marker',
                html: `<div style="background: linear-gradient(45deg, #ff5e62, #00c6ff); width: ${markerSize}px; height: ${markerSize}px; border-radius: 50%; opacity: 0.8; border: 2px solid #fff;"></div>`,
                iconSize: [markerSize, markerSize]
            }));
            return marker;
        });

        if (markers.length) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
            markers[0].openPopup();
        } else {
            map.setView([0, 0], 2);
        }
        setTimeout(() => map.invalidateSize(), 100);
    }

    function toggleMap() {
        const mapDiv = document.getElementById("earthquakeMap");
        if (mapDiv.style.display === "block") {
            mapDiv.style.display = "none";
        } else {
            mapDiv.style.display = "block";
            mapDiv.innerHTML = "";
            mapDiv.appendChild(map.getContainer());
            updateMap();
        }
    }

    window.addEventListener('resize', () => {
        if (document.getElementById("earthquakeMap").style.display === "block") {
            map.invalidateSize();
        }
    });
</script>
